---
interface Props {
	src: string;
	title?: string;
	loop?: boolean;
}

const { src, title, loop = false } = Astro.props;
---

<div class="video-container relative">
    <div class="loading-spinner absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center">
        <div class="spinner"></div>
        <p class="text-sm text-gray-500 mt-2">视频加载中...</p>
    </div>
    <video controls={!loop} loop={loop} autoplay={loop} muted={loop} playsinline={loop} src={src} title={title} class="w-full rounded-lg opacity-0 transition-opacity duration-300">
        Your browser does not support the video tag.
    </video>
    {title && <p class="text-center text-sm text-gray-500 mt-2">{title}</p>}
</div>

<style>
    .video-container {
        margin: 2em 0;
        min-height: 100px; /* Prevent layout shift while video is loading */
    }
    .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border-left-color: #09f;
        animation: spin 1s ease infinite;
        margin: 0 auto;
    }
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }
</style>

<script>
    document.querySelectorAll('.video-container').forEach(container => {
        const video = container.querySelector('video') as HTMLVideoElement;
        const spinner = container.querySelector('.loading-spinner') as HTMLElement;

        if (video && spinner) {
            const showSpinner = () => {
                if (spinner) spinner.style.display = 'block';
                if (video) video.style.opacity = '0';
            };

            const hideSpinner = () => {
                if (spinner) spinner.style.display = 'none';
                if (video) video.style.opacity = '1';
            };

            // Show spinner initially
            showSpinner();

            video.addEventListener('canplay', hideSpinner);
            video.addEventListener('waiting', showSpinner);
            video.addEventListener('playing', hideSpinner);

            // If video is already loaded from cache, it might not fire 'canplay'
            if (video.readyState >= 3) { // HAVE_FUTURE_DATA
                hideSpinner();
            }
        }
    });
</script>
