---
interface Props {
	src: string;
	title?: string;
	loop?: boolean;
}

const { src, title, loop = false } = Astro.props;
---

<div class="video-container relative">
    <div class="progress-container absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center w-4/5">
        <progress value="0" max="100" class="w-full"></progress>
        <p class="text-sm text-gray-500 mt-2">视频加载中...</p>
    </div>
    <video controls={!loop} loop={loop} autoplay={loop} muted={loop} playsinline={loop} src={src} title={title} class="w-full rounded-lg opacity-0 transition-opacity duration-300">
        Your browser does not support the video tag.
    </video>
    {title && <p class="text-center text-sm text-gray-500 mt-2">{title}</p>}
</div>

<style>
    .video-container {
        margin: 2em 0;
        min-height: 100px; /* Prevent layout shift while video is loading */
    }
    progress {
        -webkit-appearance: none;
        appearance: none;
        height: 8px;
        border-radius: 4px;
        border: none;
        overflow: hidden;
    }
    progress::-webkit-progress-bar {
        background-color: #eee;
    }
    progress::-webkit-progress-value {
        background-color: #09f;
        transition: width 0.1s ease;
    }
    progress::-moz-progress-bar {
        background-color: #09f;
        transition: width 0.1s ease;
    }
</style>

<script>
    function setupVideoPlayers() {
        document.querySelectorAll('.video-container').forEach(container => {
            const video = container.querySelector('video') as HTMLVideoElement;
            const progressContainer = container.querySelector('.progress-container') as HTMLElement;
            const progressBar = container.querySelector('progress') as HTMLProgressElement;

            if (!video || !progressContainer || !progressBar) return;

            const showProgress = () => {
                progressContainer.style.display = 'block';
                video.style.opacity = '0';
            };

            const hideProgress = () => {
                progressContainer.style.display = 'none';
                video.style.opacity = '1';
                if (!video.loop) {
                    video.play();
                }
            };
            
            showProgress();

            video.addEventListener('progress', () => {
                if (video.duration > 0) {
                    try {
                        const bufferedEnd = video.buffered.end(video.buffered.length - 1);
                        const progress = (bufferedEnd / video.duration) * 100;
                        progressBar.value = progress;
                    } catch (e) {
                        // Ignore error when no buffer is available.
                    }
                }
            });

            video.addEventListener('canplaythrough', hideProgress);
            video.addEventListener('waiting', showProgress);
            video.addEventListener('playing', () => {
                progressContainer.style.display = 'none';
                video.style.opacity = '1';
            });
            
            if (video.readyState >= 4) { // HAVE_ENOUGH_DATA
                hideProgress();
            }
        });
    }

    // Run on initial page load
    setupVideoPlayers();
    // Run on subsequent Astro page transitions
    document.addEventListener('astro:page-load', setupVideoPlayers);
</script>
